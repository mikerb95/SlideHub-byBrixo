<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'Notas IA — ' + ${presentation.name}">Notas IA — SlideHub</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body {
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }

        .card {
            background: #1e293b;
            border: 1px solid #334155;
        }

        .slide-thumb {
            width: 120px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid #334155;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .slide-thumb:hover {
            border-color: #3b82f6;
        }

        .slide-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 1rem;
        }

        .note-card {
            background: #1a2540;
            border: 1px solid #2d4a8a;
            border-radius: 8px;
            padding: 1rem;
        }

        .tag-badge {
            font-size: 0.7rem;
        }

        #generation-progress {
            transition: all 0.3s;
        }

        .phase-indicator {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .key-phrase {
            background: #1d4ed8;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 0.75rem;
        }

        .demo-tag {
            background: #059669;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 0.75rem;
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar navbar-dark" style="background:#0f172a; border-bottom:1px solid #1e293b;">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/presenter">
                <i class="fa-solid fa-presentation-screen me-2"></i>SlideHub
            </a>
            <div class="d-flex align-items-center gap-3">
                <span class="text-slate-400 small" th:text="${presentation.name}">Presentación</span>
                <a href="/presentations/import" class="btn btn-sm btn-outline-secondary">
                    <i class="fa-solid fa-arrow-left me-1"></i>Volver
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="row g-4">

            <!-- Columna izquierda: configuración y control -->
            <div class="col-lg-4">
                <div class="card rounded-3 p-3 mb-3">
                    <h6 class="text-slate-300 mb-3">
                        <i class="fa-solid fa-robot me-2 text-blue-400"></i>Generar Notas con IA
                    </h6>

                    <div class="mb-3">
                        <div class="badge mb-2"
                            th:classappend="${presentation.sourceType.name() == 'DRIVE'} ? 'bg-primary' : 'bg-success'"
                            th:text="${presentation.sourceType.name() == 'DRIVE' ? 'Google Drive' : 'Upload Manual'}">
                        </div>
                        <div class="text-white fw-semibold" th:text="${presentation.name}">Nombre</div>
                        <div class="text-slate-400 small" th:text="${totalSlides} + ' slides'">0 slides</div>
                    </div>

                    <!-- Campo repoUrl -->
                    <div class="mb-3">
                        <label class="form-label small text-slate-300">
                            <i class="fa-brands fa-github me-1"></i>Repositorio GitHub
                        </label>
                        <input type="url" id="repo-url" class="form-control bg-dark text-white border-secondary"
                            placeholder="https://github.com/user/repo" th:value="${presentation.repoUrl}">
                        <div class="form-text text-slate-500">
                            Gemini analizará el repo para generar notas más precisas.
                        </div>
                    </div>

                    <!-- Pipeline description -->
                    <div class="mb-3 p-2 rounded" style="background:#0f172a; font-size:0.78rem; color:#64748b;">
                        <div class="mb-1"><i class="fa-solid fa-eye me-1 text-purple-400"></i>Gemini Vision — analiza
                            cada slide</div>
                        <div class="mb-1"><i class="fa-solid fa-code-branch me-1 text-yellow-400"></i>Gemini — extrae
                            contexto del repo</div>
                        <div><i class="fa-solid fa-bolt me-1 text-green-400"></i>Groq — genera notas estructuradas</div>
                    </div>

                    <!-- Botón de generación -->
                    <button type="button" class="btn btn-primary w-100" id="btn-generate" onclick="generateAllNotes()">
                        <i class="fa-solid fa-wand-magic-sparkles me-2"></i>Generar Todas las Notas
                    </button>
                    <div class="form-text text-slate-500 small mt-1">
                        ~<span th:text="${totalSlides * 5}">30</span> segundos para
                        <span th:text="${totalSlides}">N</span> slides
                    </div>
                </div>

                <!-- Progreso de generación -->
                <div id="generation-progress" class="card rounded-3 p-3 d-none">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <i class="fa-solid fa-spinner fa-spin text-blue-400"></i>
                        <span class="fw-semibold small">Generando notas…</span>
                    </div>
                    <div class="progress mb-2" style="height: 6px;">
                        <div class="progress-bar bg-blue-500" id="progress-bar" role="progressbar" style="width: 0%">
                        </div>
                    </div>
                    <div id="progress-text" class="phase-indicator">Iniciando pipeline de IA…</div>
                </div>

                <!-- Resultado de generación -->
                <div id="generation-result" class="card rounded-3 p-3 d-none">
                    <div id="result-success" class="d-none">
                        <div class="text-success fw-semibold">
                            <i class="fa-solid fa-circle-check me-2"></i>¡Notas generadas!
                        </div>
                        <div id="result-count" class="text-slate-400 small mt-1"></div>
                    </div>
                    <div id="result-error" class="d-none">
                        <div class="text-danger fw-semibold">
                            <i class="fa-solid fa-triangle-exclamation me-2"></i>Error
                        </div>
                        <div id="error-message" class="text-slate-400 small mt-1"></div>
                    </div>
                </div>
            </div>

            <!-- Columna central+derecha: slides + notas -->
            <div class="col-lg-8">

                <!-- Slides con sus notas -->
                <div id="slides-container">
                    <div th:if="${#lists.isEmpty(presentation.slides)}" class="text-slate-500 text-center py-5">
                        Esta presentación no tiene slides aún.
                    </div>

                    <div th:each="slide : ${presentation.slides}" th:id="${'slide-' + slide.number}"
                        class="slide-card mb-3">
                        <div class="row g-3 align-items-start">

                            <!-- Thumbnail -->
                            <div class="col-auto">
                                <img th:src="${slide.s3Url}" th:alt="${'Slide ' + slide.number}" class="slide-thumb"
                                    loading="lazy" onerror="this.style.display='none'">
                            </div>

                            <!-- Nota del slide -->
                            <div class="col">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="badge bg-secondary me-2" th:text="${'Slide ' + slide.number}">Slide
                                        N</span>
                                    <span th:each="note : ${existingNotes}"
                                        th:if="${note.get('slideNumber') == slide.number}"
                                        class="badge bg-success tag-badge">
                                        <i class="fa-solid fa-robot me-1"></i>Nota generada
                                    </span>
                                </div>

                                <!-- Nota existente -->
                                <div th:each="note : ${existingNotes}"
                                    th:if="${note.get('slideNumber') == slide.number}"
                                    th:id="${'note-content-' + slide.number}" class="note-card">
                                    <div class="fw-semibold mb-2" th:text="${note.get('title')}">Título</div>
                                    <ul class="mb-2 ps-3" style="font-size:0.85rem;">
                                        <li th:each="point : ${note.get('points')}" th:text="${point}"
                                            class="text-slate-300 mb-1">
                                        </li>
                                    </ul>
                                    <div class="d-flex flex-wrap gap-1 mb-1">
                                        <span th:each="kp : ${note.get('keyPhrases')}" th:text="${kp}"
                                            class="key-phrase text-white"></span>
                                    </div>
                                    <div class="d-flex flex-wrap gap-1">
                                        <span th:each="tag : ${note.get('demoTags')}" th:text="${tag}"
                                            class="demo-tag text-white"></span>
                                    </div>
                                    <div class="text-slate-500 small mt-2" th:if="${note.get('suggestedTime') != null}"
                                        th:text="'⏱ ' + ${note.get('suggestedTime')}"></div>
                                </div>

                                <!-- Placeholder si no hay nota todavía -->
                                <div th:if="${#lists.isEmpty(existingNotes) || !#lists.contains(existingNotes.![get('slideNumber')], slide.number)}"
                                    th:id="${'note-placeholder-' + slide.number}"
                                    class="text-slate-500 small fst-italic py-2">
                                    No hay nota para este slide. Genera notas con IA.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const presentationId = /*[[${presentation.id}]]*/ '';
        const totalSlides = /*[[${totalSlides}]]*/ 0;

        async function generateAllNotes() {
            const repoUrl = document.getElementById('repo-url').value.trim();
            const btn = document.getElementById('btn-generate');

            btn.disabled = true;
            document.getElementById('generation-progress').classList.remove('d-none');
            document.getElementById('generation-result').classList.add('d-none');
            document.getElementById('result-success').classList.add('d-none');
            document.getElementById('result-error').classList.add('d-none');
            updateProgress(0, 'Conectando con el pipeline de IA…');

            // Fake progress animation mientras la petición está en vuelo
            let fakePct = 5;
            const fakeTimer = setInterval(() => {
                if (fakePct < 90) {
                    fakePct += Math.random() * 3;
                    const slideEst = Math.floor((fakePct / 100) * totalSlides);
                    updateProgress(fakePct,
                        `Analizando slide ~${slideEst + 1} de ${totalSlides}…`);
                }
            }, INTER_SLIDE_MS);

            const params = new URLSearchParams();
            if (repoUrl) params.append('repoUrl', repoUrl);

            try {
                const res = await fetch(
                    `/api/presentations/${presentationId}/generate-notes?${params}`,
                    { method: 'POST' }
                );
                clearInterval(fakeTimer);
                const data = await res.json();

                updateProgress(100, '¡Completado!');
                document.getElementById('generation-result').classList.remove('d-none');

                if (res.ok && data.success !== false) {
                    document.getElementById('result-success').classList.remove('d-none');
                    document.getElementById('result-count').textContent =
                        `${data.notesGenerated} de ${data.totalSlides || totalSlides} notas generadas.`;
                    // Recargar la página para mostrar las notas recién generadas
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    document.getElementById('result-error').classList.remove('d-none');
                    document.getElementById('error-message').textContent =
                        data.error || data.errorMessage || 'Error desconocido.';
                    btn.disabled = false;
                }
            } catch (e) {
                clearInterval(fakeTimer);
                document.getElementById('generation-result').classList.remove('d-none');
                document.getElementById('result-error').classList.remove('d-none');
                document.getElementById('error-message').textContent =
                    'Error de conexión: ' + e.message;
                btn.disabled = false;
            }
        }

        function updateProgress(pct, text) {
            document.getElementById('progress-bar').style.width = Math.min(100, pct) + '%';
            document.getElementById('progress-text').textContent = text;
        }

        // Tiempo estimado entre slides (ms) reflejando el delay en NotesService
        const INTER_SLIDE_MS = 1500;
    </script>
</body>

</html>