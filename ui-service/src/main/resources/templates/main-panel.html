<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SlideHub â€” Panel Maestro</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body { background: #0d1117; color: #e6edf3; min-height: 100vh; }

        .topbar {
            position: sticky; top: 0; z-index: 100;
            background: #161b22; border-bottom: 1px solid #30363d;
            padding: 0.6rem 1rem;
            display: flex; align-items: center; gap: 0.5rem;
        }

        .layout { display: flex; height: calc(100vh - 52px); }

        /* Grid de slides */
        .slide-area { flex: 1; overflow-y: auto; padding: 1rem; }

        .slide-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 0.75rem;
        }

        .slide-thumb {
            background: #161b22; border: 2px solid #30363d;
            border-radius: 6px; overflow: hidden; cursor: pointer;
            transition: border-color 0.15s, transform 0.1s;
        }
        .slide-thumb:hover { border-color: #58a6ff; transform: translateY(-2px); }
        .slide-thumb.active { border-color: #3fb950; }
        .slide-thumb img { width: 100%; aspect-ratio: 16/9; object-fit: cover; display: block; }
        .slide-thumb .slide-num { text-align: center; padding: 0.2rem; font-size: 0.75rem; opacity: 0.6; }

        /* Sidebar */
        .sidebar {
            width: 300px; min-width: 260px;
            background: #161b22; border-left: 1px solid #30363d;
            display: flex; flex-direction: column;
            overflow-y: auto;
        }
        .sidebar-section { padding: 0.75rem 1rem; border-bottom: 1px solid #21262d; }
        .sidebar-section h6 { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: #8b949e; margin-bottom: 0.5rem; }

        .quick-link-btn {
            display: flex; align-items: center; gap: 0.5rem;
            background: #0d1117; border: 1px solid #30363d;
            color: #e6edf3; border-radius: 6px;
            padding: 0.5rem 0.75rem; width: 100%; text-align: left;
            transition: background 0.15s, border-color 0.15s;
            font-size: 0.85rem; cursor: pointer;
        }
        .quick-link-btn:hover { background: #1f2428; border-color: #58a6ff; color: #58a6ff; }
        .quick-link-btn.active-demo { border-color: #f78166; color: #f78166; }
        .quick-link-btn .link-desc { font-size: 0.7rem; opacity: 0.6; display: block; }

        /* Modal CRUD */
        #links-modal .modal-content { background: #161b22; border: 1px solid #30363d; color: #e6edf3; }
        #links-modal .modal-header { border-bottom-color: #30363d; }
        #links-modal .modal-footer { border-top-color: #30363d; }
        #links-modal .form-control, #links-modal .form-select {
            background: #0d1117; border-color: #30363d; color: #e6edf3;
        }
        .link-item { background: #0d1117; border: 1px solid #21262d; border-radius: 6px; padding: 0.5rem 0.75rem; margin-bottom: 0.5rem; }
    </style>
</head>

<body>
    <div class="topbar">
        <span class="fw-bold"><i class="fa fa-table-cells-large text-success me-1"></i>Panel Maestro</span>
        <span id="slide-counter" class="badge bg-secondary ms-2">â€” / â€”</span>
        <a href="/presenter" class="btn btn-sm btn-outline-secondary ms-auto">
            <i class="fa fa-presentation-screen me-1"></i>Presentador
        </a>
        <a href="/auth/logout" class="btn btn-sm btn-outline-danger ms-1">
            <i class="fa fa-sign-out-alt"></i>
        </a>
    </div>

    <div class="layout">
        <!-- Slide Grid -->
        <div class="slide-area">
            <div class="slide-grid" id="slide-grid">
                <div class="text-center text-secondary" style="grid-column:1/-1; padding:3rem 0;">
                    <i class="fa fa-spinner fa-spin fa-2x mb-2 d-block"></i>Cargando slides...
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">

            <!-- Demo: modo slides -->
            <div class="sidebar-section">
                <h6><i class="fa fa-display me-1"></i>Modo Demo</h6>
                <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
                    <span id="demo-mode-badge" class="badge bg-secondary">slides</span>
                    <button class="btn btn-sm btn-outline-success" id="btn-demo-slides">
                        <i class="fa fa-images me-1"></i>Volver a Slides
                    </button>
                </div>
                <div class="input-group input-group-sm mb-1">
                    <input type="url" class="form-control bg-dark text-light border-secondary"
                        id="demo-url-input" placeholder="https://mi-demo.com">
                    <button class="btn btn-outline-info" id="btn-demo-url">
                        <i class="fa fa-arrow-up-right-from-square"></i>
                    </button>
                </div>
                <div class="form-text" style="color:#8b949e; font-size:0.7rem;">
                    Usar URL personalizada
                </div>
            </div>

            <!-- Quick Links -->
            <div class="sidebar-section flex-grow-1">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0"><i class="fa fa-bolt me-1"></i>Quick Links</h6>
                    <button th:if="${presentationId != ''}"
                            class="btn btn-sm btn-outline-secondary py-0 px-2"
                            style="font-size:0.7rem;"
                            data-bs-toggle="modal" data-bs-target="#links-modal">
                        <i class="fa fa-pencil"></i> Editar
                    </button>
                </div>

                <!-- Inyectado server-side desde Thymeleaf -->
                <div id="quick-links-list">
                    <div th:if="${quickLinks.isEmpty()}" class="text-center" style="color:#8b949e; font-size:0.8rem; padding: 1rem 0;">
                        <span th:if="${presentationId == ''}">
                            Abre esta vista con <code>?presentationId=...</code>
                        </span>
                        <span th:if="${presentationId != ''}">
                            Sin links configurados.
                            <a href="#" data-bs-toggle="modal" data-bs-target="#links-modal"
                               class="text-info">AÃ±adir</a>
                        </span>
                    </div>

                    <button th:each="link : ${quickLinks}"
                            th:data-url="${link.url}"
                            th:data-title="${link.title}"
                            class="quick-link-btn mb-2"
                            onclick="activateDemoLink(this.dataset.url, this.dataset.title)">
                        <i th:if="${link.icon != null}" th:class="${link.icon} + ' fa-fw'"></i>
                        <i th:if="${link.icon == null}" class="fa fa-link fa-fw"></i>
                        <span>
                            <span th:text="${link.title}">TÃ­tulo</span>
                            <span th:if="${link.description != null}"
                                  th:text="${link.description}"
                                  class="link-desc"></span>
                        </span>
                    </button>
                </div>
            </div>

        </div><!-- /sidebar -->
    </div><!-- /layout -->

    <!-- Modal CRUD Quick Links -->
    <div class="modal fade" id="links-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fa fa-bolt me-2"></i>Gestionar Quick Links</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="links-list-modal" class="mb-3"><!-- populated by JS --></div>
                    <hr style="border-color:#30363d;">
                    <h6 class="mb-2">Nuevo link</h6>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="new-link-title" placeholder="TÃ­tulo *">
                        </div>
                        <div class="col-md-6">
                            <input type="url" class="form-control" id="new-link-url" placeholder="URL *">
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="new-link-icon"
                                   placeholder="Icono FA (ej. fa-brands fa-github)">
                        </div>
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="new-link-desc" placeholder="DescripciÃ³n (opcional)">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="addQuickLink()">
                        <i class="fa fa-plus me-1"></i>AÃ±adir Link
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        const POLL_INTERVAL_MS = /*[[${pollIntervalMs}]]*/ 1000;
        const PRESENTATION_ID = /*[[${presentationId}]]*/ '';
        const API_SLIDE_URL = '/api/slide';
        const API_DEMO_URL = '/api/demo';
        const LINKS_API = '/api/presentations/' + PRESENTATION_ID + '/links';

        let currentSlide = 0;
        let totalSlides = 0;
        let demoMode = 'slides';

        const grid = document.getElementById('slide-grid');
        const counter = document.getElementById('slide-counter');
        const demoModeBadge = document.getElementById('demo-mode-badge');

        // â”€â”€ Slide grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function buildGrid(total) {
            grid.innerHTML = '';
            for (let i = 1; i <= total; i++) {
                const div = document.createElement('div');
                div.className = 'slide-thumb';
                div.dataset.slide = i;
                div.innerHTML = `<img src="/presentation/Slide${i}.PNG" alt="Slide ${i}" loading="lazy">
                                 <div class="slide-num">${i}</div>`;
                div.addEventListener('click', () => goToSlide(i));
                grid.appendChild(div);
            }
        }

        async function goToSlide(n) {
            try {
                await fetch(API_SLIDE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ slide: n })
                });
                currentSlide = n;
                updateActiveThumb();
            } catch (_) { }
        }

        function updateActiveThumb() {
            document.querySelectorAll('.slide-thumb.active').forEach(el => el.classList.remove('active'));
            const t = document.querySelector(`.slide-thumb[data-slide="${currentSlide}"]`);
            if (t) { t.classList.add('active'); t.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
            counter.textContent = `${currentSlide} / ${totalSlides}`;
        }

        // â”€â”€ Polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function fetchState() {
            try {
                const [slideRes, demoRes] = await Promise.all([fetch(API_SLIDE_URL), fetch(API_DEMO_URL)]);
                if (!slideRes.ok) return;
                const data = await slideRes.json();
                if (data.totalSlides !== totalSlides) { totalSlides = data.totalSlides; buildGrid(totalSlides); }
                if (data.slide !== currentSlide) { currentSlide = data.slide; updateActiveThumb(); }
                if (demoRes.ok) {
                    const demo = await demoRes.json();
                    demoMode = demo.mode;
                    updateDemoBadge(demo);
                }
            } catch (_) { }
        }

        function updateDemoBadge(demo) {
            if (demo.mode === 'url') {
                demoModeBadge.textContent = 'ðŸŒ Demo activa';
                demoModeBadge.className = 'badge bg-info text-dark';
                // Marcar el link activo
                document.querySelectorAll('.quick-link-btn').forEach(btn => {
                    btn.classList.toggle('active-demo', btn.dataset.url === demo.url);
                });
            } else {
                demoModeBadge.textContent = 'slides';
                demoModeBadge.className = 'badge bg-secondary';
                document.querySelectorAll('.quick-link-btn').forEach(btn => btn.classList.remove('active-demo'));
            }
        }

        // â”€â”€ Demo controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        /** Activa un quick link como demo, guardando returnSlide. */
        async function activateDemoLink(url, title) {
            try {
                await fetch(API_DEMO_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'url', url, returnSlide: currentSlide })
                });
            } catch (_) { }
        }

        document.getElementById('btn-demo-slides').addEventListener('click', async () => {
            try {
                await fetch(API_DEMO_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'slides', slide: currentSlide })
                });
            } catch (_) { }
        });

        document.getElementById('btn-demo-url').addEventListener('click', async () => {
            const url = document.getElementById('demo-url-input').value.trim();
            if (!url) return;
            try {
                await fetch(API_DEMO_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'url', url, returnSlide: currentSlide })
                });
                document.getElementById('demo-url-input').value = '';
            } catch (_) { }
        });

        // â”€â”€ CRUD Quick Links â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function loadLinksModal() {
            if (!PRESENTATION_ID) return;
            const res = await fetch(LINKS_API);
            const links = res.ok ? await res.json() : [];
            const container = document.getElementById('links-list-modal');
            if (links.length === 0) {
                container.innerHTML = '<p class="text-secondary small">Sin links todavÃ­a.</p>';
                return;
            }
            container.innerHTML = links.map(l => `
                <div class="link-item d-flex align-items-center gap-2">
                    <i class="${l.icon || 'fa fa-link'} fa-fw text-info"></i>
                    <div class="flex-grow-1">
                        <div class="fw-semibold small">${l.title}</div>
                        <div class="text-secondary" style="font-size:0.7rem;">${l.url}</div>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteLink('${l.id}')">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>`).join('');
        }

        async function addQuickLink() {
            if (!PRESENTATION_ID) return;
            const title = document.getElementById('new-link-title').value.trim();
            const url = document.getElementById('new-link-url').value.trim();
            const icon = document.getElementById('new-link-icon').value.trim() || null;
            const description = document.getElementById('new-link-desc').value.trim() || null;
            if (!title || !url) { alert('TÃ­tulo y URL son obligatorios.'); return; }
            try {
                const res = await fetch(LINKS_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, url, icon, description })
                });
                if (res.ok) {
                    ['new-link-title','new-link-url','new-link-icon','new-link-desc']
                        .forEach(id => document.getElementById(id).value = '');
                    await loadLinksModal();
                    // Recargar la pÃ¡gina para reflejar los links nuevos en el sidebar
                    location.reload();
                }
            } catch (_) { }
        }

        async function deleteLink(linkId) {
            if (!confirm('Â¿Eliminar este link?')) return;
            try {
                const res = await fetch(LINKS_API + '/' + linkId, { method: 'DELETE' });
                if (res.ok) { await loadLinksModal(); location.reload(); }
            } catch (_) { }
        }

        // Cargar links cuando se abre el modal
        document.getElementById('links-modal').addEventListener('show.bs.modal', loadLinksModal);

        // Arrancar
        fetchState();
        setInterval(fetchState, POLL_INTERVAL_MS);
    </script>
</body>
</html>