<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SlideHub — Panel Maestro</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body {
            background: #0d1117;
            color: #e6edf3;
            min-height: 100vh;
        }

        .topbar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            padding: 0.6rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .slide-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.75rem;
            padding: 1rem;
        }

        .slide-thumb {
            background: #161b22;
            border: 2px solid #30363d;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            transition: border-color 0.15s, transform 0.1s;
        }

        .slide-thumb:hover {
            border-color: #58a6ff;
            transform: translateY(-2px);
        }

        .slide-thumb.active {
            border-color: #3fb950;
        }

        .slide-thumb img {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
            display: block;
        }

        .slide-thumb .slide-num {
            text-align: center;
            padding: 0.2rem;
            font-size: 0.75rem;
            opacity: 0.6;
        }

        .demo-panel {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 1rem;
            margin: 0 1rem 1rem;
        }

        .demo-panel h6 {
            margin-bottom: 0.75rem;
        }

        #current-badge {
            background: #3fb950;
            color: black;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="topbar">
        <span class="fw-bold"><i class="fa fa-table-cells-large text-success me-1"></i>Panel Maestro</span>
        <span id="slide-counter" class="badge bg-secondary ms-2">— / —</span>
        <a href="/presenter" class="btn btn-sm btn-outline-secondary ms-auto">
            <i class="fa fa-presentation-screen me-1"></i>Presentador
        </a>
        <a href="/auth/logout" class="btn btn-sm btn-outline-danger ms-1">
            <i class="fa fa-sign-out-alt"></i>
        </a>
    </div>

    <!-- Demo Panel -->
    <div class="demo-panel">
        <h6><i class="fa fa-laptop-code me-1"></i>Modo Demo</h6>
        <div class="d-flex gap-2 align-items-center flex-wrap">
            <button class="btn btn-sm btn-outline-success" id="btn-demo-slides">
                <i class="fa fa-images me-1"></i>Volver a Slides
            </button>
            <div class="input-group" style="max-width: 400px;">
                <input type="url" class="form-control form-control-sm bg-dark text-light border-secondary"
                    id="demo-url-input" placeholder="https://mi-demo.com">
                <button class="btn btn-sm btn-outline-info" id="btn-demo-url">
                    <i class="fa fa-arrow-up-right-from-square me-1"></i>Abrir URL
                </button>
            </div>
            <span id="demo-mode-badge" class="badge bg-secondary">slides</span>
        </div>
    </div>

    <!-- Slide Grid -->
    <div class="slide-grid" id="slide-grid">
        <div class="text-center text-secondary" style="grid-column: 1/-1; padding: 3rem 0;">
            <i class="fa fa-spinner fa-spin fa-2x mb-2 d-block"></i>
            Cargando slides...
        </div>
    </div>

    <script th:inline="javascript">
        const POLL_INTERVAL_MS = /*[[${pollIntervalMs}]]*/ 1000;
        const API_SLIDE_URL = '/api/slide';
        const API_DEMO_URL = '/api/demo';

        let currentSlide = 0;
        let totalSlides = 0;

        const grid = document.getElementById('slide-grid');
        const counter = document.getElementById('slide-counter');
        const demoModeBadge = document.getElementById('demo-mode-badge');

        function buildGrid(total) {
            grid.innerHTML = '';
            for (let i = 1; i <= total; i++) {
                const div = document.createElement('div');
                div.className = 'slide-thumb';
                div.dataset.slide = i;
                div.innerHTML = `
                    <img src="/presentation/Slide${i}.PNG" alt="Slide ${i}" loading="lazy">
                    <div class="slide-num">${i}</div>
                `;
                div.addEventListener('click', () => goToSlide(i));
                grid.appendChild(div);
            }
        }

        async function goToSlide(n) {
            try {
                await fetch(API_SLIDE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ slide: n })
                });
                currentSlide = n;
                updateActiveThumb();
            } catch (_) { }
        }

        function updateActiveThumb() {
            document.querySelectorAll('.slide-thumb.active')
                .forEach(el => el.classList.remove('active'));
            const t = document.querySelector(`.slide-thumb[data-slide="${currentSlide}"]`);
            if (t) {
                t.classList.add('active');
                t.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            counter.textContent = `${currentSlide} / ${totalSlides}`;
        }

        async function fetchState() {
            try {
                const [slideRes, demoRes] = await Promise.all([
                    fetch(API_SLIDE_URL),
                    fetch(API_DEMO_URL)
                ]);
                if (!slideRes.ok) return;
                const data = await slideRes.json();
                if (data.totalSlides !== totalSlides) {
                    totalSlides = data.totalSlides;
                    buildGrid(totalSlides);
                }
                if (data.slide !== currentSlide) {
                    currentSlide = data.slide;
                    updateActiveThumb();
                }
                if (demoRes.ok) {
                    const demo = await demoRes.json();
                    demoModeBadge.textContent = demo.mode === 'url' ? `url: ${demo.url}` : 'slides';
                    demoModeBadge.className = `badge ${demo.mode === 'url' ? 'bg-info text-dark' : 'bg-secondary'}`;
                }
            } catch (_) { }
        }

        // Demo controls
        document.getElementById('btn-demo-slides').addEventListener('click', async () => {
            try {
                await fetch(API_DEMO_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'slides', slide: currentSlide })
                });
            } catch (_) { }
        });

        document.getElementById('btn-demo-url').addEventListener('click', async () => {
            const url = document.getElementById('demo-url-input').value.trim();
            if (!url) return;
            try {
                await fetch(API_DEMO_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'url', url })
                });
            } catch (_) { }
        });

        fetchState();
        setInterval(fetchState, POLL_INTERVAL_MS);
    </script>
</body>

</html>