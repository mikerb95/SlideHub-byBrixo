<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SlideHub — Presentador</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body {
            background: #0d1117;
            color: #e6edf3;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .topbar {
            background: #161b22;
            border-bottom: 1px solid #30363d;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .content {
            flex: 1;
            display: flex;
            gap: 0;
            overflow: hidden;
        }

        .slide-preview {
            background: #000;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .slide-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: none;
        }

        .slide-preview img.active {
            display: block;
        }

        .notes-panel {
            width: 380px;
            min-width: 280px;
            background: #161b22;
            border-left: 1px solid #30363d;
            overflow-y: auto;
            padding: 1rem;
        }

        .notes-placeholder {
            opacity: 0.4;
            text-align: center;
            margin-top: 3rem;
        }

        .nav-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .btn-nav {
            background: #21262d;
            border: 1px solid #30363d;
            color: white;
        }

        .btn-nav:hover {
            background: #30363d;
            color: white;
        }

        #slide-counter {
            font-size: 0.9rem;
            opacity: 0.7;
            min-width: 6rem;
            text-align: center;
        }
    </style>
</head>

<body>
    <!-- Topbar -->
    <div class="topbar">
        <span class="fw-bold"><i class="fa fa-circle-play text-success me-1"></i> SlideHub Presenter</span>
        <div class="nav-controls ms-auto">
            <button class="btn btn-sm btn-nav" id="btn-prev" disabled>
                <i class="fa fa-chevron-left"></i>
            </button>
            <span id="slide-counter">— / —</span>
            <button class="btn btn-sm btn-nav" id="btn-next" disabled>
                <i class="fa fa-chevron-right"></i>
            </button>
        </div>
        <a href="/main-panel" class="btn btn-sm btn-outline-secondary ms-2">
            <i class="fa fa-table-cells-large me-1"></i>Panel
        </a>
        <a href="/auth/logout" class="btn btn-sm btn-outline-danger ms-1" th:href="@{/auth/logout}">
            <i class="fa fa-sign-out-alt"></i>
        </a>
    </div>

    <!-- Content -->
    <div class="content">
        <div class="slide-preview" id="slide-area">
            <!-- Slides generadas dinámicamente -->
        </div>
        <div class="notes-panel" id="notes-panel">
            <h6 class="mb-3"><i class="fa fa-note-sticky me-1"></i>Notas del presentador</h6>
            <div id="notes-content">
                <div class="notes-placeholder">
                    <i class="fa fa-robot fa-2x mb-2 d-block"></i>
                    <small>Las notas de IA aparecerán aquí.<br>Genera notas desde el panel principal.</small>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const POLL_INTERVAL_MS = /*[[${pollIntervalMs}]]*/ 1500;
        const API_SLIDE_URL = '/api/slide';

        let currentSlide = 0;
        let totalSlides = 0;
        const slideArea = document.getElementById('slide-area');
        const counter = document.getElementById('slide-counter');
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');

        function buildSlides(total) {
            slideArea.innerHTML = '';
            for (let i = 1; i <= total; i++) {
                const img = document.createElement('img');
                img.src = `/presentation/Slide${i}.PNG`;
                img.alt = `Slide ${i}`;
                img.id = `pres-slide-${i}`;
                slideArea.appendChild(img);
            }
        }

        function showSlide(n) {
            document.querySelectorAll('#slide-area img.active')
                .forEach(el => el.classList.remove('active'));
            const s = document.getElementById(`pres-slide-${n}`);
            if (s) s.classList.add('active');
            counter.textContent = `${n} / ${totalSlides}`;
            btnPrev.disabled = n <= 1;
            btnNext.disabled = n >= totalSlides;
        }

        async function fetchState() {
            try {
                const res = await fetch(API_SLIDE_URL);
                if (!res.ok) return;
                const data = await res.json();
                if (data.totalSlides !== totalSlides) {
                    totalSlides = data.totalSlides;
                    buildSlides(totalSlides);
                }
                if (data.slide !== currentSlide) {
                    currentSlide = data.slide;
                    showSlide(currentSlide);
                }
            } catch (_) { }
        }

        async function navigate(delta) {
            const target = currentSlide + delta;
            if (target < 1 || target > totalSlides) return;
            try {
                await fetch(API_SLIDE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ slide: target })
                });
                currentSlide = target;
                showSlide(currentSlide);
            } catch (_) { }
        }

        btnPrev.addEventListener('click', () => navigate(-1));
        btnNext.addEventListener('click', () => navigate(1));

        fetchState();
        setInterval(fetchState, POLL_INTERVAL_MS);
    </script>
</body>

</html>